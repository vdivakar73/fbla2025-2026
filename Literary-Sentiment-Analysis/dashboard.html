<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard ‚Äî Literary Sentiment Analyzer</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header class="app-header">
        <a class="logo" href="sentiment-analyzer.html">Literary Sentiment</a>
        <nav class="header-nav" role="navigation">
            <a href="sentiment-analyzer.html">Home</a>
            <a href="dashboard.html" aria-current="page">Dashboard</a>
            <a href="tools-ingest.html">Tools</a>
            <a href="analysis.html">Analysis</a>
        </nav>
        <div class="header-right">
            <button class="icon-btn" onclick="speakCurrentText()" title="Read text">üîä</button>
            <button class="icon-btn" onclick="decreaseFontSize()" title="Decrease font">A-</button>
            <button class="icon-btn" onclick="resetFontSize()" title="Reset font">A</button>
            <button class="icon-btn" onclick="increaseFontSize()" title="Increase font">A+</button>
            <button class="icon-btn theme-toggle" onclick="toggleDarkMode()" aria-pressed="false">üåì</button>
            <button class="icon-btn" onclick="openFeedbackModal()">‚úâÔ∏è</button>
        </div>
        <nav class="header-nav" role="navigation"><a href="study-guide.html">Study Guide</a></nav>
    </header>
    
    <main class="container" style="margin-top:12px;">
      <div id="font-scale-root">
        <div class="main-grid">
            <aside class="card sidebar">
                <h3 style="margin-bottom:6px; color:var(--muted);">Analysis History</h3>
                <div id="dashHistory" style="max-height:420px; overflow:auto;">Loading...</div>
            </aside>

            <section class="card">
                <h3 style="margin-bottom:8px; color:var(--muted);">Quick Compare</h3>
                <div style="display:flex; gap:8px; flex-direction:column;">
                    <div style="display:flex; gap:8px;">
                        <textarea id="dashA" style="flex:1;height:140px;border-radius:8px;padding:10px;background:transparent;border:1px solid var(--border);" placeholder="Text A"></textarea>
                        <textarea id="dashB" style="flex:1;height:140px;border-radius:8px;padding:10px;background:transparent;border:1px solid var(--border);" placeholder="Text B"></textarea>
                    </div>
                    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:8px;">
                        <button class="btn btn-primary" onclick="dashCompare()">Compare</button>
                        <button class="btn btn-secondary" onclick="clearCompare()">Clear</button>
                    </div>
                    <div id="dashCompareResults" style="margin-top:8px;"></div>
                </div>
            </section>

            <aside class="card">
                <h3 style="margin-bottom:6px; color:var(--muted);">Annotations</h3>
                <div style="margin-bottom:12px;">
                    <button class="btn btn-primary" onclick="toggleAnnotations()">Show/Hide Annotations</button>
                    <button class="btn btn-secondary" onclick="addNewAnnotation()">Add New</button>
                    <button class="btn" onclick="exportAnnotationsJSON()">Export JSON</button>
                </div>
                <section id="annotationsSection" style="display:none;">
                    <div id="annotations-container"></div>
                </section>
                <div id="dashAnnotations" style="max-height:420px; overflow:auto;"></div>
            </aside>
        </div>
      </div>
    </main>

    <script src="ui-tools.js"></script>
    <script src="summary-manager.js"></script>
    <script src="ai-qa.js"></script>
    <script src="annotations-engine.js"></script>
    <script>
        // Initialize global state
        let currentText = '';
        let latestAnalysisData = null;

        // Utility function
        function notify(msg, type) {
            type = type || 'info';
            if (typeof showToast === 'function') {
                showToast(msg, type);
            } else {
                console.log(msg);
            }
        }

        // Render history
        function renderHistory() {
            try {
                const hist = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
                const el = document.getElementById('dashHistory');
                if (!hist.length) {
                    el.innerHTML = '<p style="color:#666;">No history yet.</p>';
                    return;
                }
                
                let html = '';
                hist.forEach(function(h) {
                    html += '<div style="border-left:3px solid #667eea;padding:8px;margin-bottom:8px;">';
                    html += '<strong>' + new Date(h.timestamp).toLocaleString() + '</strong>';
                    html += '<div style="margin-top:6px;">' + (h.preview || '').substring(0, 160) + '</div>';
                    html += '<div style="margin-top:6px;"><button class="btn" onclick="loadDash(\'' + h.id + '\')">Load</button></div>';
                    html += '</div>';
                });
                el.innerHTML = html;
            } catch (e) {
                document.getElementById('dashHistory').innerText = 'Load failed';
            }
        }

        // Load history item
        function loadDash(id) {
            try {
                const hist = JSON.parse(localStorage.getItem('analysisHistory') || '[]');
                const it = hist.find(function(h) { return String(h.id) === String(id); });
                if (!it) return;
                
                window.latestAnalysisData = it.analysis || {};
                window.currentText = it.analysis && it.analysis.text ? it.analysis.text : it.text || '';
                
                notify('Loaded history into latestAnalysisData');
            } catch (e) {
                console.warn(e);
            }
        }

        // Render annotations from localStorage
        function renderAnnotations() {
            try {
                const raw = localStorage.getItem('advancedAnnotations');
                const container = document.getElementById('dashAnnotations');
                container.innerHTML = '';
                
                if (!raw) {
                    container.innerHTML = '<p style="color:#666;">No annotations saved yet.</p>';
                    return;
                }
                
                const arr = JSON.parse(raw);
                if (!Array.isArray(arr) || !arr.length) {
                    container.innerHTML = '<p style="color:#666;">No annotations saved yet.</p>';
                    return;
                }
                
                arr.forEach(function(a) {
                    const r = document.createElement('div');
                    r.style.borderBottom = '1px solid #eee';
                    r.style.padding = '8px 6px';
                    r.innerHTML = '<div style="font-weight:600">' + (a.title || 'Annotation') + '</div>' +
                                  '<div style="color:#555;margin-top:6px;">' + (a.content || '') + '</div>';
                    container.appendChild(r);
                });
            } catch (e) {
                document.getElementById('dashAnnotations').innerText = 'Error loading annotations';
            }
        }

        // Compare texts
        // Compare texts ‚Äî academic, structural, non-BS
function splitSentences(text) {
  return text
    .replace(/\s+/g, ' ')
    .match(/[^.!?]+[.!?]+/g) || [];
}

function detectThesis(sentences) {
  const firstThird = sentences.slice(0, Math.max(3, Math.floor(sentences.length / 3)));

  return firstThird.find(s =>
    s.length > 80 &&
    /should|must|cannot|reveals|demonstrates|suggests|ultimately|therefore/i.test(s)
  ) || null;
}

function detectEvidence(sentences) {
  return sentences.filter(s =>
    /for example|for instance|such as|according to|historically|in .*?\d{4}|the author|the text|this event/i.test(s) ||
    s.match(/\b[A-Z][a-z]+ [A-Z][a-z]+\b/) // proper nouns
  );
}

function detectCommentary(sentences) {
  return sentences.filter(s =>
    /because|therefore|this means|this suggests|as a result|which leads|consequently|thus/i.test(s)
  );
}

function detectCounter(sentences) {
  return sentences.filter(s =>
    /however|although|while it may seem|some argue|critics|on the other hand/i.test(s)
  );
}

function profileAPEssay(text) {
  const sentences = splitSentences(text);

  const thesis = detectThesis(sentences);
  const evidence = detectEvidence(sentences);
  const commentary = detectCommentary(sentences);
  const counter = detectCounter(sentences);

  return {
    sentences,
    thesis,
    evidence,
    commentary,
    counter
  };
}

function writeAPComparison(A, B) {
  const lines = [];

  // THESIS
  if (A.thesis && !B.thesis) {
    lines.push(
      `Text A establishes a defensible thesis early, as seen in ‚Äú${A.thesis}.‚Äù 
      Text B‚Äôs position is more implicit, which may weaken clarity for the reader.`
    );
  } else if (B.thesis && !A.thesis) {
    lines.push(
      `Text B presents a clearer thesis, evident in ‚Äú${B.thesis},‚Äù 
      while Text A relies more on implied argument rather than direct articulation.`
    );
  } else {
    lines.push(
      `Both texts articulate their central claims implicitly rather than through direct thesis statements, 
      a common AP strategy that can be effective if reinforced consistently.`
    );
  }

  // EVIDENCE
  if (A.evidence.length > B.evidence.length + 1) {
    lines.push(
      `Text A develops its argument through more frequent and specific evidence, such as ‚Äú${A.evidence[0]},‚Äù 
      whereas Text B relies on fewer concrete references.`
    );
  } else if (B.evidence.length > A.evidence.length + 1) {
    lines.push(
      `Text B incorporates more concrete evidence, for example ‚Äú${B.evidence[0]},‚Äù 
      giving its claims greater credibility than Text A.`
    );
  } else {
    lines.push(
      `Both essays use evidence at a comparable rate, though neither consistently integrates evidence into every major claim.`
    );
  }

  // COMMENTARY (THIS IS THE BIG ONE)
  if (A.commentary.length > B.commentary.length + 1) {
    lines.push(
      `Text A more frequently explains *why* its evidence matters. 
      Commentary such as ‚Äú${A.commentary[0]}‚Äù demonstrates causal reasoning rather than summary.`
    );
  } else if (B.commentary.length > A.commentary.length + 1) {
    lines.push(
      `Text B shows stronger line-of-reasoning development, particularly in commentary like ‚Äú${B.commentary[0]},‚Äù 
      which clarifies the significance of the evidence.`
    );
  } else {
    lines.push(
      `Both texts rely heavily on evidence but often move on without fully unpacking its significance, 
      a common limitation that caps the Evidence & Commentary score.`
    );
  }

  // COUNTERARGUMENTS
  if (A.counter.length && !B.counter.length) {
    lines.push(
      `Text A acknowledges alternative perspectives, as seen in ‚Äú${A.counter[0]},‚Äù 
      which adds rhetorical sophistication. Text B does not meaningfully engage opposing views.`
    );
  } else if (B.counter.length && !A.counter.length) {
    lines.push(
      `Text B engages counterarguments, demonstrated by ‚Äú${B.counter[0]},‚Äù 
      strengthening its credibility. Text A remains largely one-sided.`
    );
  } else {
    lines.push(
      `Neither essay meaningfully develops counterarguments, limiting their complexity under AP scoring standards.`
    );
  }

  // AP JUDGMENT
  lines.push(
    `From an AP Language perspective, the stronger essay is the one that more consistently 
    connects evidence to claims through explicit reasoning. The weaker essay would benefit most from 
    expanding commentary rather than adding more examples.`
  );

  return lines;
}
function clearCompare() {
  document.getElementById('dashA').value = '';
  document.getElementById('dashB').value = '';
  document.getElementById('dashCompareResults').innerHTML = '';
  window.currentText = '';
}

function dashCompare() {
  const a = document.getElementById('dashA').value.trim();
  const b = document.getElementById('dashB').value.trim();

  if (!a || !b) {
    notify('Paste both texts to compare', 'error');
    return;
  }

  const A = profileAPEssay(a);
  const B = profileAPEssay(b);

  const feedback = writeAPComparison(A, B);
  window.currentText = 
  document.getElementById('dashA').value + ' ' +
  document.getElementById('dashB').value;

  document.getElementById('dashCompareResults').innerHTML = `
    <div style="padding:16px;border:1px solid var(--border);border-radius:12px;">
      <strong>AP Language Comparative Analysis</strong>
      ${feedback.map(f => `<p style="margin-top:10px;line-height:1.65;">${f}</p>`).join('')}
    </div>
  `;
}
//STOP HERE FOR ANALYSIS FUNCIONS







        // Show toast notification
        function showToast(message, type, duration) {
            type = type || 'info';
            duration = duration || 3000;
            
            let toast = document.getElementById('toast');
            if (!toast) {
                toast = document.createElement('div');
                toast.id = 'toast';
                toast.style.cssText = 'position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:white;z-index:10000;display:none;';
                document.body.appendChild(toast);
            }

            const colors = {
                info: '#2196F3',
                error: '#ef4444',
                success: '#10b981',
                warning: '#f59e0b'
            };

            toast.style.background = colors[type] || colors.info;
            toast.textContent = message;
            toast.style.display = 'block';

            clearTimeout(toast._timeout);
            toast._timeout = setTimeout(function() {
                toast.style.display = 'none';
            }, duration);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            renderHistory();
            renderAnnotations();

            // Restore dark mode
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.body.classList.add('dark-mode');
                const btn = document.querySelector('.theme-toggle');
                if (btn) btn.setAttribute('aria-pressed', 'true');
            }

            // Initialize summary-manager functions if available
            if (typeof renderAnnotations === 'function') {
                window.userAnnotations = window.userAnnotations || [];
            }
        });
        // Ensure font tools work on dashboard
window.getFontScaleRoot = function () {
  return document.getElementById('font-scale-root');
};

if (typeof toggleDarkMode === 'undefined' && typeof toggleTheme === 'function') {
  window.toggleDarkMode = toggleTheme;
}

    </script>
</body>
</html>