<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Analysis â€” Literary Sentiment Analyzer</title>
<link rel="stylesheet" href="styles.css">
</head>

<body>

<div id="toast" role="status" aria-live="polite"></div>

<div class="container">
  <header class="app-header">
    <a class="logo" href="sentiment-analyzer.html">
      Literary Sentiment Analyzer
    </a>

    <nav class="header-nav" aria-label="Main navigation">
      <a href="sentiment-analyzer.html">Analyze</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="tools-ingest.html">Tools</a>
      <a href="analysis.html" aria-current="page">Analysis</a>
    </nav>

    <div class="header-right">
      <button type="button" class="icon-btn" onclick="speakSummary()" title="Read summary aloud">
        ðŸ”Š
      </button>

      <button type="button" class="icon-btn" onclick="toggleDarkMode()" aria-pressed="false" title="Toggle theme">
        ðŸŒ“
      </button>

      <button type="button" class="btn btn-primary" id="toolbarGenerateBtn" onclick="generateAnalysis()">
        Generate Analysis
      </button>
      
      <nav class="header-nav" role="navigation">
        <a href="study-guide.html">Study Guide</a>
      </nav>
    </div>
  </header>

  <section class="card intro-card" style="margin: 20px 0;">
    <h1 style="margin: 0 0 10px 0; font-weight: 900; font-size: 2rem;">Advanced Text Analysis</h1>
    <p class="intro-subtitle" style="margin: 0; font-size: 1.1rem; opacity: 0.9;">
      Generate comprehensive summaries, extract key arguments, identify rhetorical strategies, and analyze text structure with AI-powered insights.
    </p>
  </section>

  <div class="main-grid">
    <aside class="card sidebar">
      <h3>Analysis Settings</h3>

      <label style="display: flex; flex-direction: column; gap: 6px;">
        <span style="font-size: 0.9rem; font-weight: 600;">Summary Length</span>
        <select id="summaryLevel" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); font-family: inherit;">
          <option value="brief">Brief (2-3 sentences)</option>
          <option value="standard" selected>Standard (4-5 sentences)</option>
          <option value="comprehensive">Comprehensive (6-8 sentences)</option>
        </select>
      </label>

      <label style="display: flex; flex-direction: column; gap: 6px;">
        <span style="font-size: 0.9rem; font-weight: 600;">Analysis Focus</span>
        <select id="analysisFocus" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); font-family: inherit;">
          <option value="general">General Analysis</option>
          <option value="rhetorical">Rhetorical Strategies</option>
          <option value="argumentative">Argument Structure</option>
          <option value="literary">Literary Elements</option>
        </select>
      </label>

      <label class="toggle-row" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input id="includeQuotesToggle" type="checkbox" checked style="cursor: pointer;">
        <span style="font-size: 0.9rem;">Include key quotes</span>
      </label>

      <label class="toggle-row" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
        <input id="showStructureToggle" type="checkbox" checked style="cursor: pointer;">
        <span style="font-size: 0.9rem;">Analyze structure</span>
      </label>

      <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 8px;">
        <button type="button" class="btn btn-secondary" onclick="pasteFromClipboard()">Paste</button>
        <button type="button" class="btn" onclick="loadFromAnalyzer()">Load from Analyzer</button>
        <button type="button" class="btn" onclick="exportAnalysis()">Export Analysis</button>
        <button type="button" class="btn" onclick="clearAll()">Clear</button>
      </div>
    </aside>

    <main class="card">
      <h2>Input Text</h2>

      <textarea
        id="inputText"
        style="width: 100%; min-height: 400px; padding: 16px; font-size: 1rem; resize: vertical;"
        placeholder="Paste or type your text here for comprehensive analysis..."
        aria-label="Text to analyze"></textarea>

      <p class="small" style="margin: 12px 0;">
        Shortcut: <strong>Ctrl + Enter</strong> to analyze Â·
        <strong>Ctrl + L</strong> to load from analyzer
      </p>

      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button
          type="button"
          id="mainGenerateBtn"
          class="btn btn-primary"
          onclick="generateAnalysis()">
          Generate Analysis
        </button>

        <button
          type="button"
          class="btn btn-secondary"
          onclick="pasteFromClipboard()">
          Paste
        </button>

        <button
          type="button"
          class="btn"
          onclick="copySummary()">
          Copy Summary
        </button>
      </div>

      <div id="quickStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 12px; margin-top: 16px;"></div>
    </main>

    <aside class="card" id="outlinePanel">
      <h3>Text Structure</h3>
      <p class="small" style="margin-bottom: 12px;">Organizational analysis of the text</p>
      <div id="outlineContent" style="color: var(--muted); font-style: italic;">
        Generate analysis to see text structure
      </div>
    </aside>

    <section id="analysisResults" class="card hidden" style="grid-column: 1 / -1;">
      <h2>Analysis Results</h2>

      <div class="tab-container">
        <div class="tabs">
          <button class="tab-button active" onclick="switchTab('summary', this)">Summary</button>
          <button class="tab-button" onclick="switchTab('arguments', this)">Key Arguments</button>
          <button class="tab-button" onclick="switchTab('rhetoric', this)">Rhetorical Analysis</button>
          <button class="tab-button" onclick="switchTab('thesis', this)">Thesis Generator</button>
          <button class="tab-button" onclick="switchTab('citations', this)">Citation Helper</button>
        </div>

        <div id="tab-summary" class="tab-content active" style="margin-top: 20px;">
          <h3 style="margin-bottom: 16px;">Content Summary</h3>
          <div id="summaryContainer"></div>
        </div>

        <div id="tab-arguments" class="tab-content hidden" style="margin-top: 20px;">
          <h3 style="margin-bottom: 16px;">Key Arguments & Claims</h3>
          <div id="argumentsContainer"></div>
        </div>

        <div id="tab-rhetoric" class="tab-content hidden" style="margin-top: 20px;">
          <h3 style="margin-bottom: 16px;">Rhetorical Strategies</h3>
          <div id="rhetoricContainer"></div>
        </div>

        <div id="tab-thesis" class="tab-content hidden" style="margin-top: 20px;">
          <h3 style="margin-bottom: 16px;">Thesis Statement Generator</h3>
          <p class="muted" style="margin-bottom: 16px;">Generate potential thesis statements for essays about this text</p>
          <button class="btn btn-primary" onclick="generateThesis()" style="margin-bottom: 16px;">Generate Thesis Statements</button>
          <div id="thesisContainer"></div>
        </div>

        <div id="tab-citations" class="tab-content hidden" style="margin-top: 20px;">
          <h3 style="margin-bottom: 16px;">Citation Helper</h3>
          <p class="muted" style="margin-bottom: 16px;">Generate citations for this text in multiple formats</p>
          
          <div style="display: flex; flex-direction: column; gap: 12px; margin-bottom: 16px;">
            <label style="display: flex; flex-direction: column; gap: 6px;">
              <span style="font-size: 0.9rem; font-weight: 600;">Author Name</span>
              <input type="text" id="authorName" placeholder="e.g., Shakespeare, William" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); font-family: inherit;">
            </label>
            
            <label style="display: flex; flex-direction: column; gap: 6px;">
              <span style="font-size: 0.9rem; font-weight: 600;">Title</span>
              <input type="text" id="workTitle" placeholder="e.g., Hamlet" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); font-family: inherit;">
            </label>
            
            <label style="display: flex; flex-direction: column; gap: 6px;">
              <span style="font-size: 0.9rem; font-weight: 600;">Publication Year</span>
              <input type="text" id="pubYear" placeholder="e.g., 1603" style="padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface); font-family: inherit;">
            </label>
          </div>
          
          <button class="btn btn-primary" onclick="generateCitations()" style="margin-bottom: 16px;">Generate Citations</button>
          <div id="citationsContainer"></div>
        </div>
      </div>
    </section>
  </div>

  <footer style="text-align: center; padding: 40px 20px; color: var(--muted); font-size: 0.9rem;">
    <p>Literary Sentiment Analyzer v3.0 | Â© 2025 | Advanced Analysis Suite</p>
  </footer>
</div>

<script>
const state = {
  currentText: '',
  darkMode: localStorage.getItem('darkMode') === 'true',
  analysis: null,
  sentences: [],
  words: []
};

function showToast(message, type, duration) {
  type = type || 'info';
  duration = duration || 3000;
  const toast = document.getElementById('toast');
  toast.className = type;
  toast.textContent = message;
  toast.style.display = 'block';
  clearTimeout(toast._timeout);
  toast._timeout = setTimeout(function() { toast.style.display = 'none'; }, duration);
}

function toggleDarkMode() {
  state.darkMode = !state.darkMode;
  document.body.classList.toggle('dark-mode');
  localStorage.setItem('darkMode', state.darkMode);
  const btn = document.querySelector('.icon-btn[onclick="toggleDarkMode()"]');
  if (btn) btn.setAttribute('aria-pressed', state.darkMode);
}

function speakSummary() {
  const summaryText = document.querySelector('#summaryContainer .summary-text')?.textContent;
  if (!summaryText) {
    showToast('Generate analysis first', 'error');
    return;
  }
  if (!window.speechSynthesis) {
    showToast('Text-to-speech not available', 'error');
    return;
  }
  const utterance = new SpeechSynthesisUtterance(summaryText);
  window.speechSynthesis.speak(utterance);
}

function updateQuickStats(text) {
  const words = text.split(/\s+/).filter(w => w).length;
  const chars = text.length;
  const sentences = text.split(/[.!?]+/).filter(s => s.trim()).length;
  const paragraphs = text.split(/\n\n+/).filter(p => p.trim()).length;
  
  let html = '<div class="metric-card"><div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 4px;">Words</div><div style="font-size: 1.75rem; font-weight: 800; color: var(--primary);">' + words + '</div></div>';
  html += '<div class="metric-card"><div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 4px;">Sentences</div><div style="font-size: 1.75rem; font-weight: 800; color: var(--primary);">' + sentences + '</div></div>';
  html += '<div class="metric-card"><div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 4px;">Paragraphs</div><div style="font-size: 1.75rem; font-weight: 800; color: var(--primary);">' + paragraphs + '</div></div>';
  html += '<div class="metric-card"><div style="font-size: 0.85rem; color: var(--muted); margin-bottom: 4px;">Avg Sent Length</div><div style="font-size: 1.75rem; font-weight: 800; color: var(--primary);">' + Math.round(words / sentences) + '</div></div>';
  document.getElementById('quickStats').innerHTML = html;
}

function extractMainIdeas(sentences) {
  const ideas = [];
  
  sentences.forEach((sent, idx) => {
    const lower = sent.toLowerCase();
    let score = 0;
    
    // First and last sentences are often key
    if (idx < 2) score += 8;
    if (idx >= sentences.length - 2) score += 6;
    
    // Important signaling words
    if (/\b(main|primary|central|key|important|significant|essential|critical|fundamental)\b/.test(lower)) score += 7;
    if (/\b(argue|claim|assert|demonstrate|show|reveal|suggest|indicate|propose)\b/.test(lower)) score += 6;
    if (/\b(however|but|although|despite|while|whereas|yet|nevertheless)\b/.test(lower)) score += 5;
    if (/\b(therefore|thus|consequently|hence|as a result|accordingly)\b/.test(lower)) score += 5;
    if (/\b(because|since|due to|owing to|given that)\b/.test(lower)) score += 4;
    
    // Sentence length sweet spot
    const wordCount = sent.split(/\s+/).length;
    if (wordCount >= 15 && wordCount <= 35) score += 3;
    
    // Contains quotes or specific examples
    if (/[""]/.test(sent)) score += 2;
    
    if (score > 0) {
      ideas.push({ text: sent.trim(), score, index: idx });
    }
  });
  
  return ideas.sort((a, b) => b.score - a.score);
}

function generateSmartSummary(text, level) {
  const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
  if (sentences.length === 0) return "Unable to generate summary from provided text.";
  
  const mainIdeas = extractMainIdeas(sentences);
  
  let numSentences;
  if (level === 'brief') numSentences = Math.min(3, sentences.length);
  else if (level === 'comprehensive') numSentences = Math.min(8, sentences.length);
  else numSentences = Math.min(5, sentences.length);
  
  // Take top scoring sentences
  const selectedIdeas = mainIdeas
    .slice(0, numSentences)
    .sort((a, b) => a.index - b.index);
  
  // Build coherent summary
  let summary = '';
  selectedIdeas.forEach((idea, i) => {
    let sent = idea.text;
    
    // Add transitions for flow
    if (i > 0 && !/^(However|But|Therefore|Thus|Additionally|Furthermore|Moreover|Similarly|In contrast)/i.test(sent)) {
      if (/\b(however|but|although|despite)\b/i.test(sent.toLowerCase())) {
        // Contrast
      } else if (/\b(therefore|thus|consequently)\b/i.test(sent.toLowerCase())) {
        // Conclusion
      } else {
        sent = 'Additionally, ' + sent.charAt(0).toLowerCase() + sent.slice(1);
      }
    }
    
    summary += (i === 0 ? '' : ' ') + sent;
  });
  
  // Ensure it's not just quoting - paraphrase introductory framing
  if (summary.length > 100) {
    summary = 'The text explores how ' + summary.charAt(0).toLowerCase() + summary.slice(1);
  }
  
  return summary;
}

function extractKeyArguments(text) {
  const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
  const arguments = [];
  
  sentences.forEach((sent, idx) => {
    const lower = sent.toLowerCase();
    let matched = false;
    
    // Main claims with strong indicators
    if (/\b(I argue|the author argues|this demonstrates|this shows|this reveals|this suggests)\b/i.test(sent) ||
        /\b(the central claim|the main argument|the thesis|the purpose)\b/i.test(sent)) {
      arguments.push({
        type: 'Central Claim',
        text: sent.trim(),
        position: idx < sentences.length * 0.3 ? 'Introduction' : idx > sentences.length * 0.7 ? 'Conclusion' : 'Body',
        strength: 'Strong'
      });
      matched = true;
    }
    
    // Evidence markers
    if (!matched && (/\b(research shows|studies indicate|data reveals|evidence suggests|according to)\b/i.test(sent) ||
        /\b(for example|for instance|specifically|in particular)\b/i.test(sent) ||
        /\b(statistics|study|research|data|findings)\b/i.test(sent))) {
      arguments.push({
        type: 'Supporting Evidence',
        text: sent.trim(),
        position: idx < sentences.length * 0.3 ? 'Introduction' : idx > sentences.length * 0.7 ? 'Conclusion' : 'Body',
        strength: 'Moderate'
      });
      matched = true;
    }
    
    // Counter-arguments
    if (!matched && (/\b(however|but|although|despite|while|whereas|yet|nevertheless|on the other hand)\b/i.test(sent) ||
        /\b(critics argue|opponents claim|some may say|it could be argued)\b/i.test(sent))) {
      arguments.push({
        type: 'Counter-Argument / Qualification',
        text: sent.trim(),
        position: idx < sentences.length * 0.3 ? 'Introduction' : idx > sentences.length * 0.7 ? 'Conclusion' : 'Body',
        strength: 'Moderate'
      });
      matched = true;
    }
    
    // Logical conclusions
    if (!matched && /\b(therefore|thus|consequently|hence|as a result|in conclusion|ultimately|finally)\b/i.test(sent)) {
      arguments.push({
        type: 'Logical Conclusion',
        text: sent.trim(),
        position: idx < sentences.length * 0.3 ? 'Introduction' : idx > sentences.length * 0.7 ? 'Conclusion' : 'Body',
        strength: 'Strong'
      });
      matched = true;
    }
    
    // Cause-effect relationships
    if (!matched && /\b(because|since|due to|leads to|results in|causes|affects)\b/i.test(sent)) {
      arguments.push({
        type: 'Causal Relationship',
        text: sent.trim(),
        position: idx < sentences.length * 0.3 ? 'Introduction' : idx > sentences.length * 0.7 ? 'Conclusion' : 'Body',
        strength: 'Moderate'
      });
    }
  });
  
  return arguments.length > 0 ? arguments : [{
    type: 'General Observation',
    text: 'The text develops its ideas through descriptive and analytical language, building meaning progressively.',
    position: 'Overall',
    strength: 'General'
  }];
}

function analyzeRhetoric(text) {
  const strategies = [];
  const lower = text.toLowerCase();
  const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
  
  // Ethos - credibility appeals
  const ethosPatterns = [
    /\b(research|study|studies|scholar|expert|authority|professor|dr\.|doctor|scientist)\b/gi,
    /\b(peer-reviewed|published|journal|academic|university)\b/gi,
    /\b(according to|as stated by|referenced in|cited in)\b/gi
  ];
  let ethosCount = 0;
  ethosPatterns.forEach(pattern => {
    ethosCount += (text.match(pattern) || []).length;
  });
  
  if (ethosCount >= 2) {
    const examples = [];
    sentences.forEach(s => {
      ethosPatterns.forEach(pattern => {
        if (pattern.test(s) && examples.length < 2) {
          examples.push('"' + s.trim().substring(0, 80) + '..."');
        }
      });
    });
    strategies.push({
      strategy: 'Ethos (Appeals to Credibility)',
      description: 'The text establishes authority by citing expert sources, research, and authoritative references. This builds trust with the audience by demonstrating that claims rest on credible foundations rather than mere opinion.',
      examples: examples.length > 0 ? examples.join(' | ') : 'Multiple references to authoritative sources throughout',
      strength: ethosCount >= 4 ? 'Strong' : 'Moderate',
      impact: 'Enhances persuasiveness by grounding arguments in expertise'
    });
  }
  
  // Pathos - emotional appeals
  const pathosPatterns = [
    /\b(feel|felt|feeling|emotion|emotional|heart|soul|passion|fear|hope|dream|love|hate)\b/gi,
    /\b(tragic|beautiful|horrible|wonderful|terrible|amazing|devastating|inspiring)\b/gi,
    /\b(suffer|joy|pain|happiness|sorrow|triumph|victory|loss|grief)\b/gi,
    /\b(imagine|picture|consider|think about|envision)\b/gi
  ];
  let pathosCount = 0;
  pathosPatterns.forEach(pattern => {
    pathosCount += (text.match(pattern) || []).length;
  });
  
  if (pathosCount >= 3) {
    const examples = [];
    sentences.forEach(s => {
      pathosPatterns.forEach(pattern => {
        if (pattern.test(s) && examples.length < 2) {
          examples.push('"' + s.trim().substring(0, 80) + '..."');
        }
      });
    });
    strategies.push({
      strategy: 'Pathos (Appeals to Emotion)',
      description: 'The author leverages emotional language and vivid imagery to connect with readers on a personal level. By evoking feelings, the text moves beyond pure logic to engage the audience\'s values and experiences.',
      examples: examples.length > 0 ? examples.join(' | ') : 'Emotional language patterns detected throughout',
      strength: pathosCount >= 6 ? 'Strong' : 'Moderate',
      impact: 'Creates emotional resonance that makes arguments memorable and compelling'
    });
  }
  
  // Logos - logical reasoning
  const logosPatterns = [
    /\b(data|statistics|statistic|fact|facts|evidence|proof|demonstrate|proves|shows)\b/gi,
    /\b(because|since|therefore|thus|consequently|hence|as a result|due to)\b/gi,
    /\b(research indicates|studies show|analysis reveals|examination demonstrates)\b/gi,
    /\b(first|second|third|finally|in addition|furthermore|moreover)\b/gi
  ];
  let logosCount = 0;
  logosPatterns.forEach(pattern => {
    logosCount += (text.match(pattern) || []).length;
  });
  
  if (logosCount >= 3) {
    const examples = [];
    sentences.forEach(s => {
      logosPatterns.forEach(pattern => {
        if (pattern.test(s) && examples.length < 2) {
          examples.push('"' + s.trim().substring(0, 80) + '..."');
        }
      });
    });
    strategies.push({
      strategy: 'Logos (Appeals to Logic)',
      description: 'The text employs logical reasoning, evidence, and systematic argumentation. Through careful use of data, causal relationships, and structured thinking, the author builds a rational case that withstands scrutiny.',
      examples: examples.length > 0 ? examples.join(' | ') : 'Logical structures and evidence-based reasoning present',
      strength: logosCount >= 6 ? 'Strong' : 'Moderate',
      impact: 'Provides rational foundation that appeals to critical thinking'
    });
  }
  
  // Repetition for emphasis
  const wordFreq = {};
  lower.split(/\W+/).forEach(word => {
    if (word.length > 6) {
      wordFreq[word] = (wordFreq[word] || 0) + 1;
    }
  });
  const repeated = Object.entries(wordFreq).filter(([w, count]) => count >= 4).sort((a, b) => b[1] - a[1]);
  
  if (repeated.length > 0) {
    strategies.push({
      strategy: 'Repetition and Emphasis',
      description: 'Strategic repetition of key terms reinforces central concepts and ensures they remain salient in the reader\'s mind. This technique creates thematic coherence and emphasizes what matters most.',
      examples: 'Repeated terms: ' + repeated.slice(0, 4).map(([w, c]) => `"${w}" (${c}x)`).join(', '),
      strength: repeated[0][1] >= 6 ? 'Strong' : 'Moderate',
      impact: 'Reinforces key concepts through strategic recurrence'
    });
  }
  
  // Rhetorical questions
  const questions = (text.match(/\?/g) || []).length;
  if (questions >= 2) {
    const questionSentences = sentences.filter(s => s.includes('?')).slice(0, 2);
    strategies.push({
      strategy: 'Rhetorical Questions',
      description: 'Poses questions to engage readers and prompt reflection rather than expecting literal answers. This technique draws audiences into active participation with the text\'s ideas.',
      examples: questionSentences.map(q => '"' + q.trim() + '"').join(' | '),
      strength: questions >= 4 ? 'Strong' : 'Moderate',
      impact: 'Engages reader thinking and creates dialogic relationship with text'
    });
  }
  
  // Contrast and juxtaposition
  const contrastPatterns = /\b(however|but|although|despite|while|whereas|yet|on the other hand|in contrast|conversely)\b/gi;
  const contrasts = (text.match(contrastPatterns) || []).length;
  if (contrasts >= 2) {
    const contrastSentences = sentences.filter(s => contrastPatterns.test(s)).slice(0, 2);
    strategies.push({
      strategy: 'Contrast and Juxtaposition',
      description: 'Deliberately positions opposing ideas or perspectives against each other to highlight differences and sharpen distinctions. This creates intellectual tension that illuminates complexity.',
      examples: contrastSentences.map(c => '"' + c.trim().substring(0, 80) + '..."').join(' | '),
      strength: contrasts >= 4 ? 'Strong' : 'Moderate',
      impact: 'Sharpens analysis by foregrounding tensions and contradictions'
    });
  }
  
  if (strategies.length === 0) {
    strategies.push({
      strategy: 'Descriptive Exposition',
      description: 'The text employs straightforward descriptive language to convey information. While not heavily rhetorical, this approach prioritizes clarity and direct communication of ideas.',
      examples: 'The text focuses on clear presentation of content',
      strength: 'Moderate',
      impact: 'Emphasizes clarity and accessibility over persuasive techniques'
    });
  }
  
  return strategies;
}

function analyzeTextStructure(text) {
  const paragraphs = text.split(/\n\n+/).filter(p => p.trim());
  if (paragraphs.length === 0) return '<p style="color: var(--muted);">No clear paragraph structure detected</p>';
  
  let html = '<div style="line-height: 2;">';
  
  // Analyze each paragraph's role
  paragraphs.forEach((para, idx) => {
    const sentences = para.match(/[^.!?]+[.!?]+/g) || [];
    const firstSent = sentences[0] || '';
    const lower = para.toLowerCase();
    
    let role = 'Supporting Paragraph';
    let description = 'Develops and elaborates on central ideas';
    let color = 'var(--primary)';
    
    if (idx === 0) {
      role = 'Introduction';
      if (/\b(this (essay|paper|text)|I (will|shall) argue|the purpose|this analysis)\b/i.test(para)) {
        description = 'Establishes thesis and roadmap for argument';
      } else {
        description = 'Opens discussion and establishes context';
      }
      color = 'var(--mint)';
    } else if (idx === paragraphs.length - 1) {
      role = 'Conclusion';
      description = 'Synthesizes arguments and provides closure';
      color = 'var(--teal)';
    } else {
      // Determine body paragraph type
      if (/\b(however|but|although|despite|yet|on the other hand)\b/i.test(firstSent)) {
        role = 'Counter-Argument';
        description = 'Addresses alternative perspectives or objections';
        color = 'var(--accent)';
      } else if (/\b(for example|for instance|specifically|such as|consider)\b/i.test(firstSent)) {
        role = 'Evidence/Example';
        description = 'Provides concrete support for claims';
        color = 'var(--sun)';
      } else if (/\b(therefore|thus|consequently|as a result)\b/i.test(firstSent)) {
        role = 'Analysis/Conclusion';
        description = 'Draws conclusions from presented evidence';
        color = 'var(--primary-strong)';
      }
    }
    
    const preview = firstSent.substring(0, 100) + (firstSent.length > 100 ? '...' : '');
    const wordCount = para.split(/\s+/).length;
    
    html += `
      <div style="padding: 12px; margin: 8px 0; background: var(--surface); border-left: 4px solid ${color}; border-radius: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;">
          <strong style="color: ${color}; font-size: 0.9rem;">${role}</strong>
          <span style="font-size: 0.75rem; color: var(--muted);">${wordCount} words</span>
        </div>
        <div style="font-size: 0.8rem; color: var(--muted); margin-bottom: 6px; font-style: italic;">${description}</div>
        <div style="font-size: 0.85rem; color: var(--text); line-height: 1.6;">${preview}</div>
      </div>
    `;
  });
  
  html += '</div>';
  return html;
}

function generateAnalysis() {
  const text = document.getElementById('inputText').value.trim();
  if (!text) {
    showToast('Please enter text to analyze', 'error');
    return;
  }
  
  state.currentText = text;
  state.sentences = text.match(/[^.!?]+[.!?]+/g) || [];
  state.words = text.toLowerCase().match(/\b[a-z]+\b/gi) || [];
  
  const toolbarBtn = document.getElementById('toolbarGenerateBtn');
  const mainBtn = document.getElementById('mainGenerateBtn');
  [toolbarBtn, mainBtn].forEach(function(b) {
    if (b) {
      b.disabled = true;
      b.dataset.orig = b.innerHTML;
      b.innerHTML = b.dataset.orig + ' <span class="spinner-mini" style="display: inline-block; width: 12px; height: 12px; border: 2px solid rgba(255,255,255,0.3); border-top-color: white; border-radius: 50%; animation: spin 0.6s linear infinite;"></span>';
    }
  });
  
  updateQuickStats(text);
  document.getElementById('analysisResults').classList.remove('hidden');
  
  setTimeout(function() {
    try {
      const level = document.getElementById('summaryLevel').value;
      const summary = generateSmartSummary(text, level);
      const compressionRatio = Math.round((summary.length / text.length) * 100);
      
      document.getElementById('summaryContainer').innerHTML = `
        <div class="card" style="padding: 20px; line-height: 1.8;">
          <div class="summary-text" style="font-size: 1.05rem; margin-bottom: 16px; line-height: 1.9;">${summary}</div>
          <div style="display: flex; gap: 16px; font-size: 0.9rem; color: var(--muted); padding-top: 12px; border-top: 1px solid var(--border);">
            <span><strong>Compression:</strong> ${compressionRatio}%</span>
            <span><strong>Summary Words:</strong> ${summary.split(/\s+/).length}</span>
            <span><strong>Reading Time:</strong> ${Math.ceil(summary.split(/\s+/).length / 200)}min</span>
          </div>
        </div>
      `;
      
      const arguments = extractKeyArguments(text);
      let argsHtml = '';
      arguments.forEach(arg => {
        const color = arg.type === 'Central Claim' ? 'var(--primary)' :
                     arg.type === 'Supporting Evidence' ? 'var(--mint)' :
                     arg.type === 'Counter-Argument / Qualification' ? 'var(--accent)' :
                     arg.type === 'Logical Conclusion' ? 'var(--teal)' : 'var(--sun)';
        argsHtml += `
          <div class="card" style="padding: 18px; margin: 14px 0; border-left: 4px solid ${color};">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong style="color: ${color}; font-size: 1rem;">${arg.type}</strong>
              <div style="display: flex; gap: 8px; align-items: center;">
                <span style="font-size: 0.75rem; color: var(--muted); font-weight: 600;">${arg.position}</span>
                <span style="font-size: 0.7rem; padding: 3px 8px; background: var(--surface); border-radius: 4px; color: ${arg.strength === 'Strong' ? 'var(--mint)' : 'var(--sun)'}; font-weight: 700;">${arg.strength}</span>
              </div>
            </div>
            <p style="margin: 0; line-height: 1.8; font-size: 0.95rem;">${arg.text}</p>
          </div>
        `;
      });
      document.getElementById('argumentsContainer').innerHTML = argsHtml;
      
      const rhetoric = analyzeRhetoric(text);
      let rhetoricHtml = '';
      rhetoric.forEach(strat => {
        const strengthColor = strat.strength === 'Strong' ? 'var(--mint)' : 'var(--sun)';
        rhetoricHtml += `
          <div class="card" style="padding: 18px; margin: 14px 0;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
              <strong style="color: var(--primary); font-size: 1.05rem;">${strat.strategy}</strong>
              <span style="font-size: 0.75rem; color: ${strengthColor}; font-weight: 700; padding: 4px 10px; background: var(--surface); border-radius: 6px;">${strat.strength}</span>
            </div>
            <p style="margin: 0 0 10px 0; line-height: 1.7; color: var(--text);">${strat.description}</p>
            <div style="background: var(--surface); padding: 10px; border-radius: 6px; margin: 10px 0;">
              <div style="font-size: 0.8rem; color: var(--muted); font-weight: 600; margin-bottom: 6px;">EXAMPLES:</div>
              <div style="font-size: 0.9rem; color: var(--text); font-style: italic; line-height: 1.6;">${strat.examples}</div>
            </div>
            <p style="margin: 8px 0 0 0; font-size: 0.85rem; color: var(--muted); padding-top: 8px; border-top: 1px solid var(--border);"><strong>Impact:</strong> ${strat.impact}</p>
          </div>
        `;
      });
      document.getElementById('rhetoricContainer').innerHTML = rhetoricHtml;
      
      document.getElementById('outlineContent').innerHTML = analyzeTextStructure(text);
      
      showToast('Analysis complete', 'info', 2500);
      
      setTimeout(function() {
        document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
      }, 100);
      
    } catch (e) {
      showToast('Analysis failed: ' + (e.message || e), 'error', 5000);
      console.error(e);
    } finally {
      [toolbarBtn, mainBtn].forEach(function(b) {
        if (b) {
          b.disabled = false;
          if (b.dataset.orig) b.innerHTML = b.dataset.orig;
        }
      });
    }
  }, 80);
}

function generateThesis() {
  if (!state.currentText) {
    showToast('Generate analysis first', 'error');
    return;
  }
  
  const text = state.currentText;
  const sentences = state.sentences;
  
  // Extract key themes from the text
  const thematicWords = {};
  state.words.forEach(word => {
    if (word.length > 6 && !/^(however|therefore|because|through|without|between|against|around|before|during|within)$/.test(word)) {
      thematicWords[word] = (thematicWords[word] || 0) + 1;
    }
  });
  
  const topThemes = Object.entries(thematicWords)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 5)
    .map(([word]) => word);
  
  const hasEvidence = /\b(research|study|data|evidence|statistics)\b/i.test(text);
  const hasContrast = /\b(however|but|although|despite|yet)\b/i.test(text);
  const hasConclusion = /\b(therefore|thus|consequently|ultimately)\b/i.test(text);
  
  const thesisStatements = [
    {
      type: 'Analytical Thesis',
      statement: `Through strategic deployment of rhetorical techniques and careful structural organization, the text demonstrates that ${topThemes[0] || 'the central concept'} operates not merely as a surface-level observation but as a complex framework for understanding how ${topThemes[1] || 'language'} shapes ${topThemes[2] || 'meaning'} and influences reader interpretation in profound ways.`
    },
    {
      type: 'Argumentative Thesis',
      statement: `While conventional readings might emphasize ${topThemes[0] || 'explicit content'}, a closer examination reveals that the author's most compelling argument emerges through the interplay between ${hasEvidence ? 'empirical evidence and ' : ''}rhetorical strategy${hasContrast ? ', with particular attention to the tensions between competing perspectives' : ''}, ultimately demonstrating that effective communication requires both logical rigor and strategic audience engagement.`
    },
    {
      type: 'Comparative/Contextual Thesis',
      statement: `The text's approach to ${topThemes[0] || 'its subject matter'} distinguishes itself through a nuanced balance between ${topThemes[1] || 'analytical precision'} and ${topThemes[2] || 'interpretive flexibility'}, challenging readers to move beyond binary interpretations and instead consider how meaning emerges from the dynamic relationship between textual elements, authorial choices, and audience reception.`
    },
    {
      type: 'Interpretive/Close Reading Thesis',
      statement: `A close examination of the text's language reveals that ${topThemes[0] || 'key terminology'} functions as more than descriptive vocabularyâ€”it establishes a conceptual architecture through which the author guides readers toward specific conclusions about ${topThemes[1] || 'the nature'} of ${topThemes[2] || 'the subject'}${hasConclusion ? ', with the text\'s conclusion reframing earlier assertions in light of accumulated evidence' : ''}.`
    }
  ];
  
  let html = '<p class="muted" style="margin-bottom: 16px;">These thesis statements are tailored to your text\'s content and themes. Customize and refine them for your specific analytical goals:</p>';
  
  thesisStatements.forEach(thesis => {
    html += `
      <div class="card" style="padding: 18px; margin: 14px 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
          <strong style="color: var(--primary); font-size: 1rem;">${thesis.type}</strong>
          <button class="btn" style="padding: 6px 14px; font-size: 0.85rem;" onclick="copyToClipboard(\`${thesis.statement.replace(/`/g, '\\`')}\`)">Copy</button>
        </div>
        <p style="margin: 0; line-height: 1.9; font-size: 0.98rem;">${thesis.statement}</p>
      </div>
    `;
  });
  
  document.getElementById('thesisContainer').innerHTML = html;
  showToast('Thesis statements generated', 'info');
}

function generateCitations() {
  const author = document.getElementById('authorName').value.trim();
  const title = document.getElementById('workTitle').value.trim();
  const year = document.getElementById('pubYear').value.trim();
  
  if (!author || !title) {
    showToast('Please enter at least author and title', 'error');
    return;
  }
  
  const citations = {
    'MLA (9th Edition)': `${author}. <em>${title}</em>${year ? `. ${year}` : ''}.`,
    'APA (7th Edition)': `${author}${year ? ` (${year})` : ' (n.d.)'}. <em>${title}</em>.`,
    'Chicago (17th Edition)': `${author}. <em>${title}</em>${year ? `. ${year}` : ''}.`,
    'Harvard': `${author}${year ? ` (${year})` : ''} <em>${title}</em>.`
  };
  
  let html = '<p class="muted" style="margin-bottom: 16px;">Citations formatted according to major style guides. Remember to add additional publication details (publisher, page numbers, etc.) as needed:</p>';
  
  Object.entries(citations).forEach(([format, citation]) => {
    html += `
      <div class="card" style="padding: 16px; margin: 12px 0;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
          <strong style="color: var(--primary); font-size: 0.95rem;">${format}</strong>
          <button class="btn" style="padding: 6px 12px; font-size: 0.85rem;" onclick="copyToClipboard(\`${citation.replace(/<[^>]*>/g, '').replace(/`/g, '\\`')}\`)">Copy</button>
        </div>
        <p style="margin: 0; line-height: 1.6; font-size: 0.95rem;">${citation}</p>
      </div>
    `;
  });
  
  document.getElementById('citationsContainer').innerHTML = html;
  showToast('Citations generated', 'info');
}

function copyToClipboard(text) {
  const clean = text.replace(/<[^>]*>/g, '');
  navigator.clipboard.writeText(clean).then(function() {
    showToast('Copied to clipboard', 'info');
  }).catch(function() {
    showToast('Failed to copy', 'error');
  });
}

function copySummary() {
  const summaryEl = document.querySelector('#summaryContainer .summary-text');
  if (!summaryEl) {
    showToast('Generate analysis first', 'error');
    return;
  }
  copyToClipboard(summaryEl.textContent);
}

function pasteFromClipboard() {
  navigator.clipboard.readText()
    .then(function(text) {
      document.getElementById('inputText').value = text;
      showToast('Pasted from clipboard', 'info');
    })
    .catch(function() {
      showToast('Unable to paste from clipboard', 'error');
    });
}

function loadFromAnalyzer() {
  try {
    const text = localStorage.getItem('ls_current_text');
    if (text) {
      document.getElementById('inputText').value = text;
      showToast('Loaded from sentiment analyzer', 'info');
    } else {
      showToast('No text found in analyzer', 'error');
    }
  } catch (e) {
    showToast('Failed to load text', 'error');
  }
}

function exportAnalysis() {
  if (!state.currentText) {
    showToast('Generate analysis first', 'error');
    return;
  }
  
  try {
    const summary = document.querySelector('#summaryContainer .summary-text')?.textContent || 'No summary';
    const level = document.getElementById('summaryLevel').value;
    
    const exportData = {
      text: state.currentText,
      summary: summary,
      level: level,
      timestamp: new Date().toISOString(),
      wordCount: state.currentText.split(/\s+/).length
    };
    
    const blob = new Blob([JSON.stringify(exportData, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'analysis-' + Date.now() + '.json';
    a.click();
    
    showToast('Analysis exported', 'info');
  } catch (e) {
    showToast('Export failed', 'error');
  }
}

function clearAll() {
  if (confirm('Clear all content?')) {
    document.getElementById('inputText').value = '';
    document.getElementById('analysisResults').classList.add('hidden');
    document.getElementById('quickStats').innerHTML = '';
    document.getElementById('outlineContent').innerHTML = '<p style="color: var(--muted); font-style: italic;">Generate analysis to see text structure</p>';
    state.currentText = '';
    showToast('Cleared', 'info');
  }
}

function switchTab(tabName, el) {
  document.querySelectorAll('.tab-content').forEach(function(t) { t.classList.add('hidden'); });
  document.querySelectorAll('.tab-button').forEach(function(t) { t.classList.remove('active'); });
  const content = document.getElementById('tab-' + tabName);
  if (content) content.classList.remove('hidden');
  if (el && el.classList) el.classList.add('active');
}

function enableShortcuts() {
  document.addEventListener('keydown', function(e) {
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
      e.preventDefault();
      generateAnalysis();
    }
    if ((e.ctrlKey || e.metaKey) && e.key === 'l') {
      e.preventDefault();
      loadFromAnalyzer();
    }
  });
}

const style = document.createElement('style');
style.textContent = `
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  .hidden { display: none !important; }
  .intro-card {
    background: linear-gradient(135deg, var(--primary), var(--secondary));
    color: white;
    border: none;
  }
  .summary-text {
    line-height: 1.9;
  }
`;
document.head.appendChild(style);

document.addEventListener('DOMContentLoaded', function() {
  if (state.darkMode) {
    document.body.classList.add('dark-mode');
  }
  
  try { enableShortcuts(); } catch (e) { console.warn('shortcuts', e); }
  
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const textParam = urlParams.get('text');
    if (textParam) {
      document.getElementById('inputText').value = decodeURIComponent(textParam);
      showToast('Text loaded from URL', 'info');
    }
  } catch (e) { console.warn('URL params', e); }
});
</script>

</body>
</html>