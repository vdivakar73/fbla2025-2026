<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tools ‚Äî Annotations & History</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <header class="app-header">
    <a class="logo" href="sentiment-analyzer.html">Literary Sentiment</a>
    <nav class="header-nav" role="navigation">
      <a href="sentiment-analyzer.html">Home</a>
      <a href="dashboard.html">Dashboard</a>
      <a href="tools-ingest.html">Tools</a>
      <a href="analysis.html">Analysis</a>
    </nav>
    <div class="header-right">
      <button class="btn" id="openStudyGuideBtn" disabled title="Open Study Guide">Study Guide</button>
      <button class="icon-btn" onclick="speakCurrentText()" title="Read text">üîä</button>
      <button class="icon-btn theme-toggle" onclick="toggleDarkMode()" aria-pressed="false">üåì</button>
      <button class="icon-btn" onclick="openFeedbackModal()">‚úâÔ∏è</button>
    </div>
  </header>

  <main class="container" style="padding:12px;">
    <div class="main-grid" style="align-items:start;">
      <section class="card">
        <div id="annotations-panel" style="margin-bottom:16px;">
          <h3>Annotations</h3>
          <div style="display:flex; gap:8px; align-items:center; margin-bottom:8px; flex-wrap:wrap;">
            <div style="flex:1; min-width:200px;">
              <input id="annSearchPanel" placeholder="Search annotations..." style="width:100%; padding:8px; border:1px solid var(--border); border-radius:6px;">
            </div>
            <div>
              <label style="font-weight:600; margin-right:8px;">Filter:</label>
              <select id="annCategoryFilterPanel" multiple style="min-width:160px; height:90px;"></select>
            </div>
            <div>
              <label style="font-weight:600; display:block;">Min Confidence: <span id="annConfLabelPanel">0</span>%</label>
              <input id="annConfPanel" type="range" min="0" max="100" value="0" oninput="document.getElementById('annConfLabelPanel').innerText=this.value">
              <div style="margin-top:8px;">
                <button class="btn" id="applyAnnFilterBtnPanel">Apply Filter</button>
                <button class="btn" id="resetAnnFilterBtnPanel">Reset</button>
              </div>
            </div>
          </div>
          <div id="annotations-container-panel"></div>
        </div>
      </section>

      <aside class="card">
        <h3 style="margin-bottom:8px; color:var(--muted);">Analysis History</h3>
        <div id="history-list-anns"></div>
      </aside>
    </div>

  <script>
    // Annotation rendering & controls (adapted from tools2)
    function showToast(message, type, duration) { type = type || 'info'; duration = duration || 3000; let toast = document.getElementById('toast'); if (!toast) { toast = document.createElement('div'); toast.id = 'toast'; toast.style.cssText = 'position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:6px;color:white;z-index:10000;display:none;'; document.body.appendChild(toast); } const colors={info:'#2196F3',error:'#ef4444',success:'#10b981',warning:'#f59e0b'}; toast.style.background = colors[type] || colors.info; toast.textContent = message; toast.style.display='block'; clearTimeout(toast._timeout); toast._timeout = setTimeout(()=>toast.style.display='none', duration); }

    function applyAnnotationFiltersPanel(categories, minConfidence) {
      const container = document.getElementById('annotations-container-panel'); if (!container) return; const cards = container.querySelectorAll('.annotation-card'); cards.forEach(function(card){ let show = true; const text = card.innerText.toLowerCase(); if (categories.length) { show = categories.some(function(c){ return text.includes(c.toLowerCase()); }); } const confMatch = text.match(/confidence[:\s]+(\d+)/i); if (confMatch) { const conf = parseInt(confMatch[1],10); if (conf < minConfidence) show=false; } card.style.display = show ? '' : 'none'; }); }

    function renderAnnotationsFromStoragePanel() {
      const raw = localStorage.getItem('advancedAnnotations'); const container = document.getElementById('annotations-container-panel'); container.innerHTML=''; if (!raw) { container.innerHTML = '<small style="color:var(--gray);">No annotations saved yet.</small>'; return; } try { const arr = JSON.parse(raw); if (!Array.isArray(arr) || arr.length===0) { container.innerHTML = '<small style="color:var(--gray);">No annotations saved yet.</small>'; return; }
        const bulkBar = document.createElement('div'); bulkBar.style.display='flex'; bulkBar.style.gap='8px'; bulkBar.style.marginBottom='8px'; bulkBar.innerHTML = '<button class="btn" id="selectAllAnnsPanel">Select All</button><button class="btn" id="deleteSelectedAnnsPanel">Delete Selected</button><button class="btn" id="exportSelectedAnnsPanel">Export Selected</button>'; container.appendChild(bulkBar);

        let needsSave=false; arr.forEach(function(a){ if(!a.id){ a.id = 'ann-'+Date.now()+'-'+Math.random().toString(36).slice(2); needsSave=true; } }); if(needsSave) localStorage.setItem('advancedAnnotations', JSON.stringify(arr));

        arr.forEach(function(a){ const card = document.createElement('div'); card.className='annotation-card'; card.style.border='1px solid var(--border)'; card.style.padding='8px'; card.style.marginBottom='8px'; card.dataset.annId = String(a.id); const cardHTML = '<div style="display:flex; gap:8px; align-items:start;"><input type="checkbox" class="ann-checkbox" data-id="'+card.dataset.annId+'" style="margin-top:6px;">' + '<div style="flex:1;"><strong>'+(a.title||'Annotation')+'</strong><div style="font-size:0.9rem;color:var(--gray); margin-top:6px;">'+(a.content||'')+'</div></div>' + '<div style="display:flex; flex-direction:column; gap:6px;"><button class="btn" onclick="addAnnotationTagPanel(\''+card.dataset.annId+'\')">Add Tag</button><button class="btn" onclick="addAnnotationCommentPanel(\''+card.dataset.annId+'\')">Add Comment</button></div></div>'; card.innerHTML = cardHTML; container.appendChild(card); });

        document.getElementById('selectAllAnnsPanel').onclick = function(){ document.querySelectorAll('.ann-checkbox').forEach(function(cb){ cb.checked = true; }); };

        document.getElementById('deleteSelectedAnnsPanel').onclick = function(){ const ids = Array.from(document.querySelectorAll('.ann-checkbox:checked')).map(c=>c.dataset.id); if(!ids.length){ showToast('No annotations selected','info'); return; } if(confirm('Delete selected annotations?')){ try{ const raw = localStorage.getItem('advancedAnnotations')||'[]'; const list = JSON.parse(raw); const remaining = list.filter(a=>!ids.includes(String(a.id))); localStorage.setItem('advancedAnnotations', JSON.stringify(remaining)); showToast('Deleted selected','info'); renderAnnotationsFromStoragePanel(); }catch(e){ console.warn(e); } } };

        document.getElementById('exportSelectedAnnsPanel').onclick = function(){ const ids = Array.from(document.querySelectorAll('.ann-checkbox:checked')).map(c=>c.dataset.id); if(!ids.length){ showToast('No annotations selected','info'); return; } try{ const raw = localStorage.getItem('advancedAnnotations')||'[]'; const list = JSON.parse(raw); const sel = list.filter(a=>ids.includes(String(a.id))); const blob = new Blob([JSON.stringify(sel, null, 2)], { type:'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = 'selected-annotations.json'; a.click(); URL.revokeObjectURL(url); showToast('Exported selected','info'); }catch(e){ console.warn(e); } };

      } catch(err){ container.innerHTML = '<small style="color:var(--danger);">Unable to read annotations.</small>'; }
    }

    function addAnnotationTagPanel(id){ const val = prompt('Add tag for annotation',''); if(!val) return; try{ const raw = localStorage.getItem('advancedAnnotations')||'[]'; const list = JSON.parse(raw); const it = list.find(x=>String(x.id)===String(id)); if(it){ it.tags = it.tags || []; it.tags.push(val); localStorage.setItem('advancedAnnotations', JSON.stringify(list)); showToast('Tag added','info'); renderAnnotationsFromStoragePanel(); } }catch(e){ console.warn(e); } }

    function addAnnotationCommentPanel(id){ const val = prompt('Add comment',''); if(!val) return; try{ const raw = localStorage.getItem('advancedAnnotations')||'[]'; const list = JSON.parse(raw); const it = list.find(x=>String(x.id)===String(id)); if(it){ it.comments = it.comments || []; it.comments.push({ text: val, ts: Date.now() }); localStorage.setItem('advancedAnnotations', JSON.stringify(list)); showToast('Comment added','info'); renderAnnotationsFromStoragePanel(); } }catch(e){ console.warn(e); } }

    // History renderer
    function renderHistoryAnns(){ const raw = localStorage.getItem('analysisHistory'); const list = document.getElementById('history-list-anns'); list.innerHTML=''; if(!raw){ list.innerHTML='<small style="color:var(--gray);">No history.</small>'; return; } try{ const arr = JSON.parse(raw).slice().reverse(); if(!arr.length){ list.innerHTML='<small style="color:var(--gray);">No history.</small>'; return; } arr.forEach(function(h){ const el = document.createElement('div'); el.style.borderBottom='1px solid var(--border)'; el.style.padding='8px 0'; el.innerHTML = '<div style="font-weight:600">'+(h.title||(h.text||'').slice(0,60))+'</div><div style="font-size:0.9rem;color:var(--gray);">'+new Date(h.timestamp||0).toLocaleString()+'</div>'; list.appendChild(el); }); }catch(err){ list.innerHTML='<small style="color:var(--danger);">Unable to read history.</small>'; } }

    function renderSampleButtonsPanel(){ const container = document.getElementById('history-list-anns'); const box = document.createElement('div'); box.style.marginBottom='12px'; box.innerHTML = '<strong>Quick Samples:</strong><div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;"></div>'; const SAMPLE_TEXTS=[{id:'sample1',title:'Short Poem',text:'The moon drifts over the silver pond. Quiet ripples sing the night.'},{id:'sample2',title:'Paragraph Excerpt',text:'She walked along the river that day, thinking of the small things that remained. The town was sleepy; a dog barked twice. Sunlight pooled on the pavement, and for a moment she felt younger.'},{id:'sample3',title:'Classic Opening',text:'It was the best of times, it was the worst of times. In the city, life moved like a great machinery, indifferent and relentless.'}]; SAMPLE_TEXTS.forEach(function(s){ const b=document.createElement('button'); b.className='btn'; b.textContent=s.title; b.onclick=function(){ localStorage.setItem('pendingExample', s.text); showToast('Sample loaded - open Home','info',1500); window.location.href='sentiment-analyzer.html'; }; box.querySelector('div').appendChild(b); }); const h = document.getElementById('history-list-anns'); if(h) h.parentNode.insertBefore(box, h); }

    document.addEventListener('DOMContentLoaded', function(){ renderSampleButtonsPanel(); renderAnnotationsFromStoragePanel(); renderHistoryAnns();
      try{ const applyBtn = document.getElementById('applyAnnFilterBtnPanel'); const resetBtn = document.getElementById('resetAnnFilterBtnPanel'); if(applyBtn) applyBtn.addEventListener('click', function(){ const selopts = Array.from(document.getElementById('annCategoryFilterPanel').selectedOptions).map(o=>o.value); const min = parseInt(document.getElementById('annConfPanel').value,10); applyAnnotationFiltersPanel(selopts, min); }); if(resetBtn) resetBtn.addEventListener('click', function(){ document.getElementById('annCategoryFilterPanel').selectedIndex = -1; document.getElementById('annConfPanel').value = 0; document.getElementById('annConfLabelPanel').innerText = '0'; renderAnnotationsFromStoragePanel(); });
      }catch(e){ console.warn('init ann filter', e); }

      const s = document.getElementById('annSearchPanel'); if(s) s.addEventListener('input', function(){ const q = s.value.trim().toLowerCase(); const container = document.getElementById('annotations-container-panel'); if(!container) return; const cards = container.querySelectorAll('.annotation-card'); cards.forEach(function(c){ const txt = c.innerText.toLowerCase(); c.style.display = txt.includes(q) ? '' : 'none'; }); });
    });
  </script>
</body>
</html>
