<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Found: Missing Item</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #0a0a0a;
            color: #e0e0e0;
            padding: 20px;
        }

        header {
            max-width: 1200px;
            margin: 0 auto 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 1rem;
        }

        h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #ffffff 0%, #b794f6 50%, #9333ea 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            max-width: 1200px;
            margin: 0 auto 1.5rem;
            color: #b794f6;
            font-size: 1.8rem;
        }

        main {
            max-width: 1200px;
            margin: 0 auto;
        }

        .card {
            background: linear-gradient(135deg, #1a0a2e 0%, #16051f 100%);
            border: 2px solid #7c3aed;
            padding: 1.5rem;
            border-radius: 12px;
            position: relative;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 32px rgba(147, 51, 234, 0.4);
        }

        .card::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            bottom: -2px;
            background: linear-gradient(135deg, #7c3aed, #9333ea, #a855f7);
            border-radius: 12px;
            z-index: -1;
            opacity: 0.3;
            filter: blur(8px);
        }

        .label {
            font-weight: 600;
            color: #b794f6;
            margin-top: 0.75rem;
        }

        a.button {
            display: inline-block;
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(147, 51, 234, 0.4);
        }

        a.button:hover {
            background: linear-gradient(135deg, #9333ea 0%, #a855f7 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(147, 51, 234, 0.6);
        }

        button {
            font: inherit;
            padding: 0.6rem 1.2rem;
            background: linear-gradient(135deg, #7c3aed 0%, #9333ea 100%);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(147, 51, 234, 0.4);
        }

        button:hover {
            background: linear-gradient(135deg, #9333ea 0%, #a855f7 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 25px rgba(147, 51, 234, 0.6);
        }

        input[type="text"] {
            width: 100%;
            padding: 0.75rem;
            background: rgba(0, 0, 0, 0.4);
            border: 2px solid #7c3aed;
            border-radius: 8px;
            font-size: 1rem;
            color: #e0e0e0;
            transition: border-color 0.3s ease;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #9333ea;
            box-shadow: 0 0 10px rgba(147, 51, 234, 0.3);
        }

        input[type="text"]::placeholder {
            color: #888;
        }

        #itemsContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 1.5rem;
        }
    </style>
</head>
<body>
        <!-- Note: Items will be taken off the site after 7 days of being unclaimed. -->
        <!--
            IMPORTANT: This page reads `localStorage.lostItems` and renders the list.
            - `datePosted` is used to sort and to determine the 7-day pruning cutoff.
            - `localStorage.selectedItem` is set when a user clicks "Coordinate Pickup" and is read by `Coordinate Pickup.html`.
        -->
    <header>
        <h1>Find Your Missing Item</h1>
        <nav>
            <!-- Link back to the main page's "find your missing item" tag/section -->
            <a class="button" href="index.html">Home</a>
        </nav>
    </header>

    <main>
        <h2 style="margin-top: 2rem; margin-bottom: 1.5rem;">Browse All Lost Items</h2>
        
        <div style="margin-bottom: 1.5rem;">
            <input type="text" id="searchInput" placeholder="Search items by name, description, category, or location..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;" />
        </div>

        <div id="itemsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;"></div>
    </main>

    <script>
        let allItems = [];

        // Calculate relevance score based on search query
        // - Higher score = more relevant. Weighted rules below prioritize exact name matches.
        function calculateRelevance(item, query) {
            const queryLower = query.toLowerCase();
            let score = 0;

            // Exact match on item name (highest priority)
            if (item.item_name.toLowerCase() === queryLower) score += 100;
            // Item name contains query
            else if (item.item_name.toLowerCase().includes(queryLower)) score += 50;

            // Category match
            if (item.category.toLowerCase().includes(queryLower)) score += 30;

            // Description match (word-by-word relevance)
            const descWords = item.description.toLowerCase().split(/\s+/);
            const queryWords = queryLower.split(/\s+/);
            
            queryWords.forEach(word => {
                if (descWords.includes(word)) score += 10;
                else if (descWords.some(dw => dw.includes(word))) score += 5;
            });

            // Location match
            if (item.location.toLowerCase().includes(queryLower)) score += 15;

            return score;
        }

        // Filter and sort items by relevance
        // - If query empty: show all items. Otherwise show only items with relevance > 0.
        function searchItems(query) {
            const container = document.getElementById('itemsContainer');
            
            if (!query.trim()) {
                displayItems(allItems);
                return;
            }

            // Score and filter items
            const filtered = allItems
                .map(item => ({
                    ...item,
                    relevance: calculateRelevance(item, query)
                }))
                .filter(item => item.relevance > 0)
                .sort((a, b) => b.relevance - a.relevance);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="card" style="background: #fef3cd; border: 1px solid #ffc107; color: #856404; grid-column: 1/-1;">
                        <strong>No items found matching "${escapeHtml(query)}".</strong> Try different keywords.
                    </div>
                `;
                return;
            }

            displayItems(filtered);
        }

        // Display items in grid
        // - Builds each card, includes contact `mailto:` link and the Coordinate Pickup button
        function displayItems(items) {
            const container = document.getElementById('itemsContainer');

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="card" style="background: #fef3cd; border: 1px solid #ffc107; color: #856404; grid-column: 1/-1;">
                        <strong>No lost items yet.</strong> Submit a report on the <a href="page2.html" style="color: #0366d6;">File Missing Item</a> page.
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map((item, index) => `
                <div class="card">
                    ${item.image ? `<img src="${item.image}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 8px; margin-bottom: 1rem; border: 2px solid #7c3aed;" alt="Item" />` : ''}
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #b794f6; font-size: 1.4rem;">${escapeHtml(item.item_name)}</h3>
                        <span style="background: linear-gradient(135deg, #7c3aed, #9333ea); color: #fff; padding: 0.35rem 0.7rem; border-radius: 6px; font-size: 0.85rem; font-weight: bold;">${escapeHtml(item.category)}</span>
                    </div>
                    
                    <div class="label" style="margin-top: 0.75rem;">Description:</div>
                    <div style="color: #d1d5db; line-height: 1.6;">${escapeHtml(item.description)}</div>
                    
                    <div class="label">Last Known Location:</div>
                    <div style="color: #9ca3af;">${escapeHtml(item.location)}</div>
                    
                    <div class="label">Date Lost:</div>
                    <div style="color: #9ca3af;">${escapeHtml(item.date_lost)}</div>
                    
                    <div style="background: rgba(0, 0, 0, 0.4); padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 1px solid #7c3aed;">
                        <div class="label" style="margin-top: 0;">Report Found By:</div>
                        <div style="color: #d1d5db; margin-top: 0.5rem;">If This Is Your Lost Item, Contact:</div>
                        <div style="margin-top: 0.5rem; font-weight: bold; color: #b794f6;">${escapeHtml(item.name)}</div>
                        <div><a href="mailto:${escapeHtml(item.email)}" style="color: #9333ea; text-decoration: none; font-weight: bold;">${escapeHtml(item.email)}</a></div>
                    </div>
                    
                    <div style="color: #6b7280; font-size: 0.85rem; margin-top: 0.75rem;">Posted: ${escapeHtml(item.datePosted)}</div>
                    <button onclick="viewItem(${index})" style="margin-top: 1rem; width: 100%;">Coordinate Pickup</button>
                </div>
            `).join('');
        }

        // Load all items from localStorage
        // - Prunes items older than 7 days and persists the pruned list back to localStorage
        function loadItems() {
            allItems = JSON.parse(localStorage.getItem('lostItems') || '[]');

            // Automatically remove items that have been unclaimed for more than 7 days
            const container = document.getElementById('itemsContainer');
            try {
                const now = new Date();
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - 7);

                const kept = allItems.filter(item => {
                    const d = new Date(item.datePosted);
                    // if date parsing fails, keep the item (avoid accidental deletion)
                    if (isNaN(d)) return true;
                    return d >= cutoff;
                });

                const removedCount = allItems.length - kept.length;
                if (removedCount > 0) {
                    // persist the pruned list
                    localStorage.setItem('lostItems', JSON.stringify(kept));
                    allItems = kept;

                    // show a small non-blocking notice above the items container
                    const noticeId = 'pruneNotice';
                    let noticeEl = document.getElementById(noticeId);
                    if (!noticeEl) {
                        noticeEl = document.createElement('div');
                        noticeEl.id = noticeId;
                        noticeEl.style.cssText = 'background:#fff3cd;border:1px solid #ffc107;color:#856404;padding:.75rem;border-radius:6px;margin-bottom:1rem;';
                        container.parentNode.insertBefore(noticeEl, container);
                    }
                    noticeEl.innerHTML = `<strong>${removedCount} item(s) removed:</strong> Items unclaimed for over 7 days were automatically removed.`;
                }
            } catch (e) {
                // If anything goes wrong with pruning, fall back to displaying everything
                console.warn('Pruning failed:', e);
            }

            // Sort by date posted (newest first)
            allItems.sort((a, b) => new Date(b.datePosted) - new Date(a.datePosted));

            displayItems(allItems);
        }

        // When a user wants to coordinate pickup, save the selected item and go to Coordinate Pickup.html
        // - Saves selected item to `localStorage.selectedItem` so `Coordinate Pickup.html` can render it
        // When a user wants to coordinate pickup, save the selected item and go to Coordinate Pickup.html
// The function now uses the item's unique array index for reliable selection.
        function viewItem(index) {
            const selected = allItems[index]; // <-- CORRECT WAY: Select item directly by index
            
            if (!selected) {
                alert('Item not found. Please refresh the page.');
                return;
            }
            
            // store selected item for Coordinate Pickup.html to read
            localStorage.setItem('selectedItem', JSON.stringify(selected));
            
            // navigate to Coordinate Pickup.html where pickup coordination can occur
            window.location.href = 'coordinate-pickup.html';
        }

        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
        }

        // Load items when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadItems();
            
            // Add real-time search listener
            document.getElementById('searchInput').addEventListener('input', function(e) {
                searchItems(e.target.value);
            });
        });
    </script>

</body>
</html>