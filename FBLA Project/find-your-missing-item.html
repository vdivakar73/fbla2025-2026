<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Found: Missing Item</title>
    <style>
        body { font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial; max-width: 720px; margin: 2rem auto; padding: 0 1rem; color: #111; }
        header { display:flex; justify-content:space-between; align-items:center; gap:1rem; margin-bottom:1.5rem; }
        h1 { font-size:1.25rem; margin:0; }
        .card { border:1px solid #e3e3e3; padding:1rem; border-radius:8px; background:#fafafa; }
        .label { font-weight:600; color:#333; margin-top:.5rem; }
        .empty { color:#c300ff; margin-top:1rem; }
        a.button { display:inline-block; padding:.45rem .75rem; background:#0366d6; color:#fff; text-decoration:none; border-radius:6px; }
        button, input[type="text"] { font:inherit; }
        .controls { margin-top:1rem; display:flex; gap:.5rem; flex-wrap:wrap; }
    </style>
</head>
<body>
        <!-- Note: Items will be taken off the site after 7 days of being unclaimed. -->
        <!--
            IMPORTANT: This page reads `localStorage.lostItems` and renders the list.
            - `datePosted` is used to sort and to determine the 7-day pruning cutoff.
            - `localStorage.selectedItem` is set when a user clicks "Coordinate Pickup" and is read by `Coordinate Pickup.html`.
        -->
    <header>
        <h1>Find Your Missing Item</h1>
        <nav>
            <!-- Link back to the main page's "find your missing item" tag/section -->
            <a class="button" href="index.html">Home</a>
        </nav>
    </header>

    <main>
        <h2 style="margin-top: 2rem; margin-bottom: 1.5rem;">Browse All Lost Items</h2>
        
        <div style="margin-bottom: 1.5rem;">
            <input type="text" id="searchInput" placeholder="Search items by name, description, category, or location..." style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem;" />
        </div>

        <div style="display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap;">
            <select id="categoryFilter" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; flex: 1; min-width: 200px;">
                <option value="">All Categories</option>
                <option value="electronics">Electronics</option>
                <option value="clothing">Clothing</option>
                <option value="accessories">Accessories</option>
                <option value="documents">Documents</option>
                <option value="other">Other</option>
            </select>

            <select id="dateFilter" style="padding: 0.75rem; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; flex: 1; min-width: 200px;">
                <option value="">All Dates</option>
                <option value="today">Today</option>
                <option value="week">This Week</option>
                <option value="month">This Month</option>
            </select>

            <button onclick="clearFilters()" style="padding: 0.75rem 1.5rem; background: #dc3545; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600;">Clear Filters</button>
        </div>

        <div id="itemsContainer" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem;"></div>
    </main>

    <script>
        let allItems = [];

        // Calculate relevance score based on search query
        // - Higher score = more relevant. Weighted rules below prioritize exact name matches.
        function calculateRelevance(item, query) {
            const queryLower = query.toLowerCase();
            let score = 0;

            // Exact match on item name (highest priority)
            if (item.item_name.toLowerCase() === queryLower) score += 100;
            // Item name contains query
            else if (item.item_name.toLowerCase().includes(queryLower)) score += 50;

            // Category match
            if (item.category.toLowerCase().includes(queryLower)) score += 30;

            // Description match (word-by-word relevance)
            const descWords = item.description.toLowerCase().split(/\s+/);
            const queryWords = queryLower.split(/\s+/);
            
            queryWords.forEach(word => {
                if (descWords.includes(word)) score += 10;
                else if (descWords.some(dw => dw.includes(word))) score += 5;
            });

            // Location match
            if (item.location.toLowerCase().includes(queryLower)) score += 15;

            return score;
        }

        // Filter and sort items by relevance
        // - If query empty: show all items. Otherwise show only items with relevance > 0.
        function searchItems(query) {
            const container = document.getElementById('itemsContainer');
            
            if (!query.trim()) {
                displayItems(allItems);
                return;
            }

            // Score and filter items
            const filtered = allItems
                .map(item => ({
                    ...item,
                    relevance: calculateRelevance(item, query)
                }))
                .filter(item => item.relevance > 0)
                .sort((a, b) => b.relevance - a.relevance);

            if (filtered.length === 0) {
                container.innerHTML = `
                    <div class="card" style="background: #fef3cd; border: 1px solid #ffc107; color: #856404; grid-column: 1/-1;">
                        <strong>No items found matching "${escapeHtml(query)}".</strong> Try different keywords.
                    </div>
                `;
                return;
            }

            displayItems(filtered);
        }

        // Display items in grid
        // - Builds each card, includes contact `mailto:` link and the Coordinate Pickup button
        function displayItems(items) {
            const container = document.getElementById('itemsContainer');

            if (items.length === 0) {
                container.innerHTML = `
                    <div class="card" style="background: #fef3cd; border: 1px solid #ffc107; color: #856404; grid-column: 1/-1;">
                        <strong>No lost items yet.</strong> Submit a report on the <a href="file-a-complaint.html" style="color: #0366d6;">File Missing Item</a> page.
                    </div>
                `;
                return;
            }

            container.innerHTML = items.map((item, index) => {
                // Generate placeholder icon based on category
                const categoryIcons = {
                    'electronics': 'ðŸ“±',
                    'clothing': 'ðŸ‘•',
                    'accessories': 'ðŸ‘œ',
                    'documents': 'ðŸ“„',
                    'other': 'ðŸ“¦'
                };
                const icon = categoryIcons[item.category.toLowerCase()] || 'ðŸ“¦';
                const imagePlaceholder = `<div style="width: 100%; height: 200px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; margin-bottom: 1rem; display: flex; align-items: center; justify-content: center; font-size: 80px;">${icon}</div>`;
                
                return `
                <div class="card" style="background: #fff; border: 2px solid #0366d6;">
                    ${item.image ? `<img src="${item.image}" style="width: 100%; height: 200px; object-fit: cover; border-radius: 4px; margin-bottom: 1rem;" alt="Item" />` : imagePlaceholder}
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <h3 style="margin: 0 0 0.5rem 0; color: #0366d6;">${escapeHtml(item.item_name)}</h3>
                        <span style="background: #0366d6; color: #fff; padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.85rem;">${escapeHtml(item.category)}</span>
                    </div>
                    
                    <div class="label" style="margin-top: 0.75rem;">Description:</div>
                    <div style="color: #333; line-height: 1.5;">${escapeHtml(item.description)}</div>
                    
                    <div class="label">Last Known Location:</div>
                    <div style="color: #666;">${escapeHtml(item.location)}</div>
                    
                    <div class="label">Date Lost:</div>
                    <div style="color: #666;">${escapeHtml(item.date_lost)}</div>
                    
                    <div style="background: #f0f0f0; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
                        <div class="label" style="margin-top: 0;">Report Found:</div>
                        <div>If This Is Your Lost Item, Contact:</div>
                        <div style="margin-top: 0.5rem; font-weight: bold;">${escapeHtml(item.name)}</div>
                        <div><a href="mailto:${escapeHtml(item.email)}" style="color: #0366d6; text-decoration: none;">${escapeHtml(item.email)}</a></div>
                    </div>
                    
                    <div style="color: #999; font-size: 0.85rem; margin-top: 0.75rem;">Posted: ${escapeHtml(item.datePosted)}</div>
                    <button onclick="viewItem(${index})" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer;">Coordinate Pickup</button>
                </div>
            `;
            }).join('');
        }

        // Load all items from localStorage
        // - Prunes items older than 7 days and persists the pruned list back to localStorage
        function loadItems() {
            allItems = JSON.parse(localStorage.getItem('lostItems') || '[]');

            // Automatically remove items that have been unclaimed for more than 7 days
            const container = document.getElementById('itemsContainer');
            try {
                const now = new Date();
                const cutoff = new Date();
                cutoff.setDate(cutoff.getDate() - 7);

                const kept = allItems.filter(item => {
                    const d = new Date(item.datePosted);
                    // if date parsing fails, keep the item (avoid accidental deletion)
                    if (isNaN(d)) return true;
                    return d >= cutoff;
                });

                const removedCount = allItems.length - kept.length;
                if (removedCount > 0) {
                    // persist the pruned list
                    localStorage.setItem('lostItems', JSON.stringify(kept));
                    allItems = kept;

                    // show a small non-blocking notice above the items container
                    const noticeId = 'pruneNotice';
                    let noticeEl = document.getElementById(noticeId);
                    if (!noticeEl) {
                        noticeEl = document.createElement('div');
                        noticeEl.id = noticeId;
                        noticeEl.style.cssText = 'background:#fff3cd;border:1px solid #ffc107;color:#856404;padding:.75rem;border-radius:6px;margin-bottom:1rem;';
                        container.parentNode.insertBefore(noticeEl, container);
                    }
                    noticeEl.innerHTML = `<strong>${removedCount} item(s) removed:</strong> Items unclaimed for over 7 days were automatically removed.`;
                }
            } catch (e) {
                // If anything goes wrong with pruning, fall back to displaying everything
                console.warn('Pruning failed:', e);
            }

            // Sort by date posted (newest first)
            allItems.sort((a, b) => new Date(b.datePosted) - new Date(a.datePosted));

            displayItems(allItems);
        }

        // When a user wants to coordinate pickup, save the selected item and go to Coordinate Pickup.html
        // - Saves selected item to `localStorage.selectedItem` so `Coordinate Pickup.html` can render it
        // When a user wants to coordinate pickup, save the selected item and go to Coordinate Pickup.html
// The function now uses the item's unique array index for reliable selection.
        function viewItem(index) {
            const selected = allItems[index]; // <-- CORRECT WAY: Select item directly by index
            
            if (!selected) {
                alert('Item not found. Please refresh the page.');
                return;
            }
            
            // store selected item for Coordinate Pickup.html to read
            localStorage.setItem('selectedItem', JSON.stringify(selected));
            
            // navigate to Coordinate Pickup.html where pickup coordination can occur
            window.location.href = 'coordinate-pickup.html';
        }

        function escapeHtml(s) {
            return String(s).replace(/[&<>"']/g, function(m) { return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; });
        }

        // Load items when page loads
        document.addEventListener('DOMContentLoaded', function() {
            loadItems();
            
            // Add real-time search listener
            document.getElementById('searchInput').addEventListener('input', function(e) {
                applyFilters();
            });

            // Add filter listeners
            document.getElementById('categoryFilter').addEventListener('change', applyFilters);
            document.getElementById('dateFilter').addEventListener('change', applyFilters);
        });

        // Apply all filters
        function applyFilters() {
            const searchQuery = document.getElementById('searchInput').value;
            const category = document.getElementById('categoryFilter').value;
            const dateFilter = document.getElementById('dateFilter').value;

            let filtered = allItems;

            // Apply category filter
            if (category) {
                filtered = filtered.filter(item => item.category.toLowerCase() === category);
            }

            // Apply date filter
            if (dateFilter) {
                const now = new Date();
                filtered = filtered.filter(item => {
                    const itemDate = new Date(item.datePosted);
                    if (dateFilter === 'today') {
                        return itemDate.toDateString() === now.toDateString();
                    } else if (dateFilter === 'week') {
                        const weekAgo = new Date(now - 7 * 24 * 60 * 60 * 1000);
                        return itemDate >= weekAgo;
                    } else if (dateFilter === 'month') {
                        const monthAgo = new Date(now - 30 * 24 * 60 * 60 * 1000);
                        return itemDate >= monthAgo;
                    }
                    return true;
                });
            }

            // Apply search filter
            if (searchQuery.trim()) {
                filtered = filtered
                    .map(item => ({
                        ...item,
                        relevance: calculateRelevance(item, searchQuery)
                    }))
                    .filter(item => item.relevance > 0)
                    .sort((a, b) => b.relevance - a.relevance);
            }

            displayItems(filtered);
        }

        // Clear all filters
        function clearFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('dateFilter').value = '';
            applyFilters();
        }
    </script>

</body>
</html>