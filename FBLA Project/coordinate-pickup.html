<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width,initial-scale=1" />
	<title>Coordinate Pickup</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Poppins', system-ui, -apple-system, "Segoe UI", Roboto, Arial; 
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a2e 50%, #0a0a0a 100%);
            background-attachment: fixed;
            min-height: 100vh;
            color: #e0e0e0;
            padding: 2rem 1rem;
        }
        header { 
            max-width: 900px;
            margin: 0 auto 2rem;
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            background: rgba(26, 10, 46, 0.6);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(138, 43, 226, 0.3);
            backdrop-filter: blur(10px);
        }
        h1 {
            background: linear-gradient(135deg, #9d4edd, #c77dff);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 700;
            font-size: 1.75rem;
        }
        h3 {
            color: #c77dff;
            margin-top: 1rem;
        }
        main {
            max-width: 900px;
            margin: 0 auto;
        }
        a.button { 
            background: linear-gradient(135deg, #7b2cbf, #9d4edd); 
            color: #fff; 
            padding: .6rem 1.2rem; 
            border-radius: 8px; 
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: 1px solid rgba(138, 43, 226, 0.5);
        }
        a.button:hover {
            background: linear-gradient(135deg, #9d4edd, #c77dff);
            box-shadow: 0 4px 15px rgba(138, 43, 226, 0.5);
            transform: translateY(-2px);
        }
        .card { 
            border: 1px solid rgba(138, 43, 226, 0.4); 
            padding: 1.5rem; 
            border-radius: 12px; 
            background: linear-gradient(135deg, rgba(26, 10, 46, 0.8), rgba(15, 5, 25, 0.9));
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(138, 43, 226, 0.2);
        }
        .row { display: flex; gap: 1rem; flex-wrap: wrap; }
        label { display: block; font-weight: 600; margin-top: .8rem; color: #c77dff; }
        input, textarea, select { 
            width: 100%; 
            padding: .75rem; 
            border: 1px solid rgba(138, 43, 226, 0.4); 
            border-radius: 8px;
            background: rgba(26, 10, 46, 0.6);
            color: #e0e0e0;
            backdrop-filter: blur(10px);
            font-family: inherit;
        }
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #9d4edd;
            box-shadow: 0 0 0 3px rgba(157, 78, 221, 0.2);
        }
        .actions { margin-top: 1rem; display: flex; gap: .5rem; }
        .btn { 
            padding: .75rem 1.5rem; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        .btn-primary { 
            background: linear-gradient(135deg, #2d6a4f, #40916c); 
            color: white;
        }
        .btn-primary:hover {
            background: linear-gradient(135deg, #40916c, #52b788);
            box-shadow: 0 4px 15px rgba(64, 145, 108, 0.4);
            transform: translateY(-2px);
        }
        .btn-danger { 
            background: linear-gradient(135deg, #c41e3a, #e63946); 
            color: white;
        }
        .btn-danger:hover {
            background: linear-gradient(135deg, #e63946, #f08080);
            box-shadow: 0 4px 15px rgba(230, 57, 70, 0.4);
            transform: translateY(-2px);
        }
        .muted { color: #a0a0a0; font-size: .9rem; }
        hr {
            border: none;
            border-top: 1px solid rgba(138, 43, 226, 0.3);
            margin: 1rem 0;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
</head>
</head>
<body>
	<header>
		<h1>Coordinate Pickup</h1>
		<nav><a class="button" href="find-your-missing-item.html">← Back to Items</a></nav>
	</header>

	<main>
		<div id="content"></div>
	</main>

	<script>
		/* IMPORTANT: This page reads `localStorage.selectedItem` to render a selected item.
		     Pickup requests are saved to `localStorage.pickupRequests` and collected items are removed
		     from `localStorage.lostItems` when marked as collected.
		*/
		// Escape text before rendering into HTML
		function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[m]; }); }

		// Find item index helper (used when marking collected)
		function findItemIndex(items, item) {
			return items.findIndex(i => i.datePosted === item.datePosted && i.item_name === item.item_name && i.email === item.email);
		}

		function openComposer(email, subject, body) {
			const gmailUrl = 'https://mail.google.com/mail/?view=cm&fs=1'
				+ '&to=' + encodeURIComponent(email)
				+ '&su=' + encodeURIComponent(subject)
				+ '&body=' + encodeURIComponent(body);
			window.open(gmailUrl, '_blank');
		}

		function renderSelected(selected) {
			const container = document.getElementById('content');
						container.innerHTML = `
								<div class="card">
									${selected.image ? `<img src="${selected.image}" style="width: 100%; height: 250px; object-fit: cover; border-radius: 6px; margin-bottom: 1rem;" alt="Item" />` : ''}
									<h2 style="margin-top:0;">${escapeHtml(selected.item_name)}</h2>
									<div class="muted">Category: ${escapeHtml(selected.category)} • Date lost: ${escapeHtml(selected.date_lost)}</div>
									<p style="margin-top:1rem;">${escapeHtml(selected.description)}</p>
									<div><strong>Last Known Location:</strong> ${escapeHtml(selected.location)}</div>
									<div style="margin-top:.5rem;"><strong>Contact:</strong> ${escapeHtml(selected.name)} — <a href="mailto:${escapeHtml(selected.email)}">${escapeHtml(selected.email)}</a></div>

									<hr style="margin:1rem 0;" />

									<h3>Request a pickup / coordinate</h3>
									<form id="pickupForm">
										<label for="preferred">Preferred pickup date & time</label>
										<input id="preferred" type="datetime-local" />

										<label for="phone">Your phone (optional)</label>
										<input id="phone" type="text" placeholder="Phone or contact method" />

										<label for="note">Note / pickup instructions (optional)</label>
										<textarea id="note" rows="3" placeholder="Where to meet, locker number, etc."></textarea>

										${selected.category.toLowerCase() === 'electronics' ? `
											<div style="background: #fff3cd; border: 1px solid #ffc107; padding: 1rem; border-radius: 6px; margin-top: 1rem;">
												<label style="margin-top: 0;">Verification Required (Electronics)</label>
												<p style="margin: 0.5rem 0 0 0; color: #856404; font-size: 0.9rem;">Since this is an electronics item, please provide verification that you are the rightful owner:</p>
												
												<label for="verification" style="margin-top: 0.75rem;">Verification (serial number, IMEI, description of damage, etc.)</label>
												<textarea id="verification" rows="3" placeholder="Provide details that prove ownership..." required></textarea>
											</div>
										` : ''}

										<div class="actions">
											<button type="submit" class="btn btn-primary">Request Pickup</button>
											<button type="button" id="collectedBtn" class="btn btn-danger">Mark as Collected</button>
										</div>

										<div style="margin-top: .75rem; display:flex; gap:.5rem; flex-wrap:wrap;">
											<button id="gmailBtn" type="button" class="btn" style="background:#4285F4;color:#fff;">Email Owner (Gmail)</button>
											<button id="mailtoBtn" type="button" class="btn" style="background:#6c757d;color:#fff;">Open Mail Client</button>
										</div>
									</form>

									<div id="status" style="margin-top:1rem;"></div>
								</div>`;

						// pickup form submit
						document.getElementById('pickupForm').addEventListener('submit', function(e){
								e.preventDefault();
								const pref = document.getElementById('preferred').value;
								const phone = document.getElementById('phone').value;
								const note = document.getElementById('note').value;
								
								// Check if verification is required and filled
								let verification = '';
								if (selected.category.toLowerCase() === 'electronics') {
									const verField = document.getElementById('verification');
									if (!verField.value.trim()) {
										alert('Please provide verification details for this electronics item.');
										return;
									}
									verification = verField.value;
								}
								
								const req = { item: selected, preferred: pref, phone, note, verification, requestedAt: new Date().toLocaleString() };
								const arr = JSON.parse(localStorage.getItem('pickupRequests') || '[]');
								arr.push(req);
								localStorage.setItem('pickupRequests', JSON.stringify(arr));
								document.getElementById('status').innerHTML = '<div style="color:green;">Pickup request saved. The owner has been notified (if email provided).</div>';
						});

						// Mark as collected
						document.getElementById('collectedBtn').addEventListener('click', function(){
								if (!confirm('Are you sure you want to mark this item as collected? This will remove it from the public list.')) return;
								const items = JSON.parse(localStorage.getItem('lostItems') || '[]');
								const idx = findItemIndex(items, selected);
								if (idx > -1) {
										items.splice(idx,1);
										localStorage.setItem('lostItems', JSON.stringify(items));
								}
						localStorage.removeItem('selectedItem');
						window.location.href = 'find-your-missing-item.html';
				});						// Email buttons
						document.getElementById('gmailBtn').addEventListener('click', function(){
								const subject = `Pickup coordination: ${selected.item_name}`;
								const body = `Hello ${selected.name},%0A%0AI would like to coordinate pickup for the item titled "${selected.item_name}".%0APreferred time: %0A%0AMessage:%0A`;
								openComposer(selected.email, subject, body);
						});

						document.getElementById('mailtoBtn').addEventListener('click', function(){
								const subject = `Pickup coordination: ${selected.item_name}`;
								const body = `Hello ${selected.name},\n\nI would like to coordinate pickup for the item titled "${selected.item_name}".\nPreferred time:\n\nMessage:\n`;
								const mailto = 'mailto:' + encodeURIComponent(selected.email) + '?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body);
								window.location.href = mailto;
						});
		}

		function renderChooser(items){
			const container = document.getElementById('content');
			if (!items || items.length === 0) {
				container.innerHTML = '<div class="card">No items available. Go to <a href="file-a-complaint.html">File Missing Item</a> to add one.</div>';
				return;
			}
			container.innerHTML = '<h2>Select an item to coordinate pickup</h2>' + items.map((it, idx) => `\
				<div class="card" style="margin-bottom: .75rem;">\
					<div style="display:flex;justify-content:space-between;align-items:center;">\
						<div>\
							<strong>${escapeHtml(it.item_name)}</strong><div class="muted">${escapeHtml(it.category)} — ${escapeHtml(it.date_lost)}</div>\
						</div>\
						<div>\
							<button class="btn" onclick='selectAndGo(${idx})' style="background:#0366d6;color:#fff;border-radius:6px;padding:.5rem 0.75rem;border:none;">Coordinate</button>\
						</div>\
					</div>\
				</div>`).join('');
		}

		function selectAndGo(index) {
			const items = JSON.parse(localStorage.getItem('lostItems') || '[]');
			const selected = items[index];
			if (!selected) return alert('Item not found');
			localStorage.setItem('selectedItem', JSON.stringify(selected));
			// reload page to show selected view
			location.reload();
		}

		// Init
		(function(){
			const selected = JSON.parse(localStorage.getItem('selectedItem') || 'null');
			if (selected) {
				renderSelected(selected);
				return;
			}
			const items = JSON.parse(localStorage.getItem('lostItems') || '[]');
			renderChooser(items);
		})();
	</script>
</body>
</html>
